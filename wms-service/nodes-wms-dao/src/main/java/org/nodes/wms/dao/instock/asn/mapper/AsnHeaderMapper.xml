<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.nodes.wms.dao.instock.asn.mapper.AsnHeaderMapper">

    <select id="selectPageAsnBill" resultType="org.nodes.wms.dao.instock.asn.dto.output.PageResponse">
        SELECT h.asn_bill_id,
               h.asn_bill_no,
               h.asn_bill_state,
               h.create_type,
               h.s_code,
               h.s_name,
               h.external_order_no,
               h.external_create_user,
               h.wh_code,
               h.asn_bill_remark,
               h.create_time,
               h.create_user,
               h.update_time
        FROM asn_header h
                 LEFT JOIN asn_detail d
                           on h.asn_bill_id = d.asn_bill_id
        <where>
            <if test="params.asnBillNo != null and params.asnBillNo != ''">
                AND h.asn_bill_no = #{params.asnBillNo}
            </if>
            <if test="params.skuCode != null and params.skuCode != ''">
                AND d.sku_code = #{params.skuCode}
            </if>
            <if test="params.asnBillState != null and params.asnBillState.size >0">
                AND h.asn_bill_state IN
                <foreach collection="params.asnBillState" separator="," item="item" open="(" close=")">
                     #{item}
                </foreach>
            </if>
            <if test="params.createTimeBegin != null ">
                AND h.create_time &gt;= #{params.createTimeBegin}
            </if>
            <if test="params.createTimeEnd != null">
                AND h.create_time &lt;= #{params.createTimeEnd}
            </if>
            <if test="params.suppliers != null and params.suppliers != ''">
                AND (h.s_code LIKE concat('%',#{params.suppliers},'%') OR h.s_name LIKE concat('%',#{params.suppliers},'%'))
            </if>
            <if test="params.externalOrderNo != null and params.externalOrderNo != ''">
                AND h.external_order_no = #{params.externalOrderNo}
            </if>
            <if test="params.externalCreateUser != null and params.externalCreateUser != ''">
                AND h.external_create_user = #{params.externalCreateUser}
            </if>
            <if test="params.whCode != null and params.whCode != ''">
                AND h.wh_code = #{params.whCode}
            </if>
        </where>
        <!--    ${ew.customSqlSegment} -->

    </select>

    <select id="selectAsnContactDetail"
            resultType="org.nodes.wms.dao.instock.asn.dto.output.AsnDetailResponse"
            resultMap="asnDetailMap">
        SELECT
            h.asn_bill_id,
            h.asn_bill_no,
            h.create_type,
            h.s_code,
            h.s_name,
            h.asn_bill_remark,
            h.create_time,
            h.create_user,
            w.wh_code,
            w.wh_name,
            d.asn_detail_id,
            d.asn_line_no,
            d.sku_code,
            d.sku_name,
            d.um_name,
            d.plan_qty,
            d.scan_qty,
            d.remark,
            d.detail_status,
            r.receive_id,
            r.receive_no,
            r.bill_state,
            r.remark as receive_remark,
            r.create_time as receive_create_time,
            r.create_user as receive_create_user,
            r.update_time as receive_update_time,
            r.update_user as receive_update_time
        FROM
            asn_header h
                LEFT JOIN asn_detail d ON h.asn_bill_id = d.asn_bill_id
                LEFT JOIN wms_warehouse w ON h.wh_id = w.wh_id
                LEFT JOIN receive_header r ON h.asn_bill_id = r.asn_bill_id
        WHERE h.asn_bill_id = #{id}
    </select>

    <resultMap id="asnDetailMap" type="org.nodes.wms.dao.instock.asn.dto.output.AsnDetailResponse">
        <id column="asn_bill_id" property="asnBillId"/>
        <result column="asn_bill_no" property="asnBillNo"/>
        <result column="create_type" property="createType"/>
        <result column="s_code" property="sCode"/>
        <result column="s_name" property="sName"/>
        <result column="asn_bill_remark" property="asnBillRemark"/>
        <result column="create_time" property="createTime"/>
        <result column="create_user" property="createUser"/>
        <result column="wh_code" property="whCode"/>
        <result column="wh_name" property="whName"/>

        <collection property="asnDetails" ofType="org.nodes.wms.dao.instock.asn.dto.output.AsnPropertyDetailResponse">
            <id column="asn_detail_id" property="asnDetailId"/>
            <result column="asn_line_no" property="asnLineNo"/>
            <result column="sku_code" property="skuCode"/>
            <result column="sku_name" property="skuName"/>
            <result column="um_name" property="umName"/>
            <result column="plan_qty" property="planQty"/>
            <result column="scan_qty" property="scanQty"/>
            <result column="remark" property="remark"/>
            <result column="detail_status" property="detailStatus"/>
        </collection>

        <collection property="receiveHeaders" ofType="org.nodes.wms.dao.instock.asn.dto.output.AsnPropertyReceiveResponse">
            <id column="receive_id" property="receiveId"/>
            <result column="receive_no" property="receiveNo"/>
            <result column="bill_state" property="billState"/>
            <result column="receive_remark" property="remark"/>
            <result column="receive_create_time" property="createTime"/>
            <result column="receive_create_user" property="createUser"/>
            <result column="receive_create_time" property="updateTime"/>
            <result column="receive_create_user" property="updateUser"/>
        </collection>
    </resultMap>

    <select id="selectAsnBillList" resultType="org.nodes.wms.dao.instock.asn.dto.output.AsnExportResponse">
        SELECT
            h.asn_bill_id,
            h.asn_bill_no,
            h.asn_bill_state,
            h.create_type,
            h.s_code,
            h.s_name,
            h.external_order_no,
            h.external_create_user,
            h.wh_code,
            h.asn_bill_remark,
            h.create_time,
            h.create_user,
            h.update_time
        FROM asn_header h
        LEFT JOIN asn_detail d
        on h.asn_bill_id = d.asn_bill_id
        <where>
            <if test="params.asnBillNo != null and params.asnBillNo != ''">
                AND h.asn_bill_no = #{params.asn_bill_no}
            </if>
            <if test="params.skuCode != null and params.skuCode != ''">
                AND d.sku_code = #{params.sku_code}
            </if>
            <if test="params.asnBillState != null and params.asnBillState != ''">
                AND  h.asn_bill_state in
                <foreach collection="params.asnBillState" separator="," item="item" open="(" close="">
                    #{item}
                </foreach>
            </if>
            <if test="params.createTimeBegin != null ">
                AND h.create_time &gt;= #{params.createTimeBegin}
            </if>
            <if test="params.createTimeEnd != null">
                AND h.create_time &lt;= #{params.createTimeEnd}
            </if>
            <if test="params.suppliers != null and params.suppliers != ''">
                AND (h.s_code LIKE #{params.suppliers} OR h.s_name LIKE #{params.suppliers})
            </if>
            <if test="params.externalOrderNo != null and params.externalOrderNo != ''">
                AND h.external_order_no = #{params.external_order_no}
            </if>
            <if test="params.externalCreateUser != null and params.externalCreateUser != ''">
                AND h.external_create_user = #{params.external_create_user}
            </if>
            <if test="params.whCode != null and params.whCode != ''">
                AND h.wh_code = #{params.wh_code}
            </if>
        </where>
    </select>
</mapper>
