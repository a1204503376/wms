<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.nodes.wms.dao.stock.mapper.StockMapper">

    <select id="selectStockQtyByLocIdList" resultType="java.util.HashMap">
        SELECT SUM(stock_qty-pick_qty) AS skuQty, MAX( TIMESTAMPDIFF(DAY, last_in_time, now()) ) AS skuStoreDay
        FROM wms_stock
        WHERE
        stock_qty &gt; pick_qty
        AND loc_id IN
        <foreach collection="locIdList" open="(" close=")" item="item" separator=",">
            #{item}
        </foreach>
    </select>

    <select id="selectStockSkuCountByLocIdList" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT sku_id)
        FROM wms_stock
        WHERE stock_qty &gt; pick_qty
        AND loc_id NOT IN
        <foreach collection="locIdList" separator="," item="item" close=")" open="(">
            #{item}
        </foreach>
    </select>

    <select id="getList" resultType="org.nodes.wms.dao.stock.dto.output.FindAllStockByNoResponse">
        select s.stock_id, s.stock_status, s.sku_level, s.wsp_name, s.wsp_id , s.sku_id, s.sku_code, s.sku_name,
        s.stay_stock_qty,s.stock_qty,s.pick_qty, s.occupy_qty, s.box_code, s.lpn_code, s.loc_id , s.loc_code,
        s.zone_id, s.zone_code, s.wh_id, s.wh_code , s.wo_id, s.last_in_time, s.last_out_time, s.lot_number,
        s.wsu_code , s.version, s.sku_lot1, s.sku_lot2, s.sku_lot3, s.sku_lot4 , s.sku_lot5, s.sku_lot6, s.sku_lot7,
        s.sku_lot8, s.sku_lot9 , s.sku_lot10, s.sku_lot11, s.sku_lot12, s.sku_lot13, s.sku_lot14 , s.sku_lot15,
        s.sku_lot16, s.sku_lot17, s.sku_lot18, s.sku_lot19 , s.sku_lot20, s.sku_lot21, s.sku_lot22, s.sku_lot23,
        s.sku_lot24 , s.sku_lot25, s.sku_lot26, s.sku_lot27, s.sku_lot28, s.sku_lot29 , s.sku_lot30, o.owner_name as ownerName
        from wms_stock s left join wms_owner o on s.wo_id = o.wo_id
        <where>
            <if test="query.no != null and query.no != ''">
                s.loc_code LIKE CONCAT('%', #{query.no} ,'%') and s.wh_id =  #{query.whId} and s.is_deleted = 0 and s.stay_stock_qty + s.stock_qty > s.pick_qty
                and s.stock_status = 0 or
                s.sku_code LIKE CONCAT('%', #{query.no} ,'%') and s.wh_id =  #{query.whId} and s.is_deleted = 0 and s.stay_stock_qty + s.stock_qty > s.pick_qty
                and stock_status = 0 or
                s.box_code LIKE CONCAT('%', #{query.no} ,'%') and s.wh_id =  #{query.whId} and s.is_deleted = 0 and s.stay_stock_qty + s.stock_qty > s.pick_qty
                and s.stock_status = 0
            </if>
        </where>
    </select>
    <select id="getPage" resultType="org.nodes.wms.dao.stock.dto.output.StockPageResponse">
        select s.stock_id,
        s.sku_code,
        s.stock_status,
        s.sku_lot1,
        s.pick_qty,
        s.stock_qty,
        s.occupy_qty,
        s.wsu_code,
        s.loc_code,
        s.zone_code,
        s.box_code,
        s.lpn_code,
        s.sku_lot2,
        s.sku_lot3,
        s.sku_lot4,
        s.sku_lot5,
        s.sku_lot6,
        s.sku_lot7,
        s.sku_lot8,
        wh.wh_code,
        wo.owner_code,
        wo.owner_name,
        s.last_in_time,
        s.last_out_time
        from wms_stock s
        left join wms_warehouse wh on s.wh_id = wh.wh_id
        left join wms_owner wo on s.wo_id = wo.wo_id
        <where>
            AND s.is_deleted ='0'
            <if test="query.skuCode!=null and query.skuCode != ''">
                AND s.sku_code LIKE concat('%',#{query.skuCode},'%')
            </if>
            <if test="query.SkuLot1!=null and query.SkuLot1 != ''">
                AND s.sku_lot1 LIKE concat('%',#{query.skuLot1},'%')
            </if>
            <if test="query.locCode!=null and query.locCode != ''">
                AND s.loc_code LIKE concat('%',#{query.locCode},'%')
            </if>

        </where>
    </select>
</mapper>
